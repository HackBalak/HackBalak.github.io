<h2 id="what-is-covenanat-c2-">What is covenanat C2 ?</h2>

<p><img src="https://raw.githubusercontent.com/wiki/cobbr/Covenant/covenant.png?raw=true" width="1200" height="300" /></p>

<p><a href="https://github.com/cobbr/Covenant">Covenant</a> is a .NET command and control framework and web application that aims to highlight the attack surface of .NET, make the use of offensive .NET tradecraft easier, and serve as a collaborative <strong>command and control (C2)</strong> platform for red teamers.
Covenant is an ASP.NET Core, cross-platform application that includes a web-based interface that allows for multi-user collaboration.</p>

<p>The <a href="https://github.com/cobbr/Covenant/wiki">Wiki</a> documents most of Covenant’s core features and how to use them.</p>

<h2 id="what-is-a-c2-redirector-">What is a C2 redirector ?</h2>

<p>Redirectors are an essential component for advanced red teaming. Redirectors allow malicious traffic to come and go as it pleases, but remain hidden from detection.</p>

<p>The objective of a redirector is to mask the core C2 infrastructure from prying blue team eyes, and allow the red team operator hidden communication with a compromised machine.</p>

<p>Redirectors seek to mask and protect their backend server, the main orchestration server for all C2.</p>

<p>The picture below explains the principe idea of C2 redirector :</p>

<p><img src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/set-up-nginx-c2-redirector/C2-redirector.png?raw=true" width="600" height="400" /></p>

<p>Simplified, but you get the idea…</p>

<p>Redirectors offer many advantages around obfuscation but they also offer a resilience and persistence advantage. If the blue team are able to successfully identify and block an IP address associated with the C2 infrastructure, the red team operator can quickly spin up a redirector and continue to keep the core backend server IP address hidden. 
There is many solutions to do so, but we choose to use an Nginx web server and make it behave like a <strong>reverse proxy</strong> to redirect the traffic communication between the covenant c2 server and the victim machine.</p>

<p>Now and after getting an Idea about what is a C2 redirector, let’s move to the Implementation :) .</p>

<h2 id="implementation">Implementation</h2>

<p>After Installing Covenant C2 tools on your machine and making sure that is work correctly, you will just need to keep in mind its <strong>@ip address</strong>, because we will need it later for the nginx setup configuration file.</p>

<p>Now prepare another Linux machine – in my case I am using ubuntu – and install Nginx server on it.</p>

<p>The next step is nothing more than editing the <em>“/etc/nginx/sites-enabled/default”</em> file, delete all the previous content , and add the following configuration :</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>
server <span class="o">{</span>
        listen 80 default_server<span class="p">;</span>
        listen <span class="o">[</span>::]:80  default_server<span class="p">;</span>

        root /var/www/html<span class="p">;</span>

        index index.html index.htm index.nginx-debian.html<span class="p">;</span>

        server_name <span class="k">*</span>.example.org<span class="p">;</span>

        location / <span class="o">{</span>
                try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ @c2<span class="p">;</span>
        <span class="o">}</span>

        location @c2 <span class="o">{</span>
                proxy_pass http://@covenant-ip-address<span class="p">;</span>
                proxy_redirect off<span class="p">;</span>
                proxy_ssl_verify off<span class="p">;</span>
                proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
                proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="o">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>then Restart the Nginx service.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>service nginx restart
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now your Nginx redirector is ready, on your futur attack make sure to put the <strong>@ip address</strong> of the machine where nginx is installed and configured on the covenant Listener Tab.</p>

<p>The video below is the PoC of this setup ;)</p>

<p>Enjoy, and don’t forget to leave a beautifull comment below …</p>

<div class="embed-container">
  <iframe width="100%" height="400" src="https://drive.google.com/file/d/1wrYcCAjLUpVK_4k0k3HafbB7FKs61r3n/preview" frameborder="0" allowfullscreen="">
  </iframe>
</div>

