<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Getting started with the Microsoft-Windows-Threat-Intelligence ETW Provider" /><meta name="author" content="HackBalak" /><meta property="og:locale" content="en" /><meta name="description" content="TL;DR The Microsoft-Windows-Threat-Intelligence ETW Provider is a very powerful tool to detect many kill chain attacks such as memory injection and others. In this blog, I will show a way to take advantage of this provider, consume its events logs and ship them to ELK stack. Before jumping to the technical steps, let’s talk a little bit about the Threat Intelligence ETW(Event Tracing for Windows) Provider. The Microsoft-Windows-Threat-Intelligence ETW Provider is an excellent tool to detect process injection, and other type of attacks. Unlike usermode hooking or in-process ETW Providers, avoiding or tampering with the Threat-Intelligence is very difficult. However, to subscribe to this Provider requires a process with very special privileges, marked as Protected Process Light (PPL) ‘Anti-Malware’ or higher. To legitimately run a program at this level you must submit a driver to Microsoft to be co-signed by them, something not everyone has the inclination or reputation to do. source : pathtofile Let’s get started … DISCLAMER: In this article, I am not going to cover the deployment of the ELK stack. I may write another blog talking about multiple ways to deploy it in your own lab. But mainly here I am just using this docker-compose which will do all the boring configuration stuff on your behalf. Required Tools Windows 10 VM ELK stack WinlogBeat NSSM SealighterTI Walkthrough Step 1 On a windows 10 VM, download the Assets from the links below : SealighterTI.exe + sealighter_provider.man PS: Disable windows defender before downloading the SealighterTI.exe, because it will consider it malicious. Otherwise, you can clone the repository on your machine and build the exe. For my case, I just downloaded the pre-built binarie, it works fine. Check the SealighterTI Project for more details. Step 2 Create a repository on the C:\Program Files\ location, and move the two downloaded files. Then, go to Microsoft windows defender, and add that folder to windows defender exclusion. Select the SealighterTI folder and click Ok. after that you can activate windows defender real-time protection again. Step 3 First Open up the sealigher_provider.man in a text editor, and replace all uses of !!SEALIGHTER_LOCATION!! with the full path to the SealighterTI.exe binary. Then from an elevated command prompt run: 1 wevtutil im path/to/sealigher_provider.man Step 4 Download NSSM ,Extract it and move it to C:\Program Files\. What is nssm.exe? The genuine nssm.exe file is a software component of NSSM by Iian Patterson. Non-Sucking Service Manager is a service manager for Microsoft Windows. Nssm.exe launches the Non-Sucking Service Manager program. This is not an essential Windows process and can be disabled if known to create problems. NSSM is a free utility that manages background and foreground services and processes. The program can be set to automatically restart failing services. The program also logs all progress in an Event Log, making it easier to identify applications that aren’t behaving as they should. We will use NSSM to run SealighterTI as a service automatically without the need to start it every time you reboot your machine. open an Administrator command prompt, change directory to the location of the nssm exe, and run the following command. nssm install SealighterTI a window will pop-up as the picture shows above. you just have to fill in the path of the sealighterTI folder and executable and the argument -d . Then click on Install service . And finally the SealighterTI service is installed succesfully. Step 5 Open windows services.msc , Find SealighterTI service and click on Start. and you’re done. Now go to Event Viewer and check The Sealighter/Operational logs. NOTE : After running the SealighterTI service, you’ll discover that the number of event logs on event viewer doesn’t bypass 5** event, and you may think that the TI provider doesn’t log correctly.however that is not correct,But you just need to configure the Log proprieties on the right panel on event viewer, then change The maximum log size to a bigger number ^_^ Step 6 Now it’s Time to ship Microsoft-Windows-Threat-Intelligence ETW provider logs to ELK stack. Download Winlogbeat zip and extract it. Create a Folder on C:\Program Files\ and name it winlogbeat and move all the extracted files from the zip folder. Open winlogbeat.yml and add this line under the winlogbeat.event_logs . 1 2 3 winlogbeat.event_logs: - name: Sealighter/Operational More configuration details can be found on the official elastic website. Open powershell as administrator and change directory to C:\Program Files\Winlogbeat, and run commands below : 1 2 3 4 5 PowerShell.exe -ExecutionPolicy UnRestricted -File .\install-service-winlogbeat.ps1 .\winlogbeat.exe test config -c .\winlogbeat.yml -e .\winlogbeat.exe setup -e Start-Service winlogbeat Finally, go to ELK and check, you’ll see all the logs Ingested successfully to Kibana web Interface. Conclusion Today, we managed to succesfully view and consume the Microsoft-Windows-Threat-Intelligence Provider events log, and ship them To ELK stack. In the Next post, I will show you how we can take advantage of this provider to detect some adversary attack like Process Injection, and to understand why Microsoft’s “Threat Intelligence Tracing” is useful and much needed in detection of modern and often obscure injection techniques." /><meta property="og:description" content="TL;DR The Microsoft-Windows-Threat-Intelligence ETW Provider is a very powerful tool to detect many kill chain attacks such as memory injection and others. In this blog, I will show a way to take advantage of this provider, consume its events logs and ship them to ELK stack. Before jumping to the technical steps, let’s talk a little bit about the Threat Intelligence ETW(Event Tracing for Windows) Provider. The Microsoft-Windows-Threat-Intelligence ETW Provider is an excellent tool to detect process injection, and other type of attacks. Unlike usermode hooking or in-process ETW Providers, avoiding or tampering with the Threat-Intelligence is very difficult. However, to subscribe to this Provider requires a process with very special privileges, marked as Protected Process Light (PPL) ‘Anti-Malware’ or higher. To legitimately run a program at this level you must submit a driver to Microsoft to be co-signed by them, something not everyone has the inclination or reputation to do. source : pathtofile Let’s get started … DISCLAMER: In this article, I am not going to cover the deployment of the ELK stack. I may write another blog talking about multiple ways to deploy it in your own lab. But mainly here I am just using this docker-compose which will do all the boring configuration stuff on your behalf. Required Tools Windows 10 VM ELK stack WinlogBeat NSSM SealighterTI Walkthrough Step 1 On a windows 10 VM, download the Assets from the links below : SealighterTI.exe + sealighter_provider.man PS: Disable windows defender before downloading the SealighterTI.exe, because it will consider it malicious. Otherwise, you can clone the repository on your machine and build the exe. For my case, I just downloaded the pre-built binarie, it works fine. Check the SealighterTI Project for more details. Step 2 Create a repository on the C:\Program Files\ location, and move the two downloaded files. Then, go to Microsoft windows defender, and add that folder to windows defender exclusion. Select the SealighterTI folder and click Ok. after that you can activate windows defender real-time protection again. Step 3 First Open up the sealigher_provider.man in a text editor, and replace all uses of !!SEALIGHTER_LOCATION!! with the full path to the SealighterTI.exe binary. Then from an elevated command prompt run: 1 wevtutil im path/to/sealigher_provider.man Step 4 Download NSSM ,Extract it and move it to C:\Program Files\. What is nssm.exe? The genuine nssm.exe file is a software component of NSSM by Iian Patterson. Non-Sucking Service Manager is a service manager for Microsoft Windows. Nssm.exe launches the Non-Sucking Service Manager program. This is not an essential Windows process and can be disabled if known to create problems. NSSM is a free utility that manages background and foreground services and processes. The program can be set to automatically restart failing services. The program also logs all progress in an Event Log, making it easier to identify applications that aren’t behaving as they should. We will use NSSM to run SealighterTI as a service automatically without the need to start it every time you reboot your machine. open an Administrator command prompt, change directory to the location of the nssm exe, and run the following command. nssm install SealighterTI a window will pop-up as the picture shows above. you just have to fill in the path of the sealighterTI folder and executable and the argument -d . Then click on Install service . And finally the SealighterTI service is installed succesfully. Step 5 Open windows services.msc , Find SealighterTI service and click on Start. and you’re done. Now go to Event Viewer and check The Sealighter/Operational logs. NOTE : After running the SealighterTI service, you’ll discover that the number of event logs on event viewer doesn’t bypass 5** event, and you may think that the TI provider doesn’t log correctly.however that is not correct,But you just need to configure the Log proprieties on the right panel on event viewer, then change The maximum log size to a bigger number ^_^ Step 6 Now it’s Time to ship Microsoft-Windows-Threat-Intelligence ETW provider logs to ELK stack. Download Winlogbeat zip and extract it. Create a Folder on C:\Program Files\ and name it winlogbeat and move all the extracted files from the zip folder. Open winlogbeat.yml and add this line under the winlogbeat.event_logs . 1 2 3 winlogbeat.event_logs: - name: Sealighter/Operational More configuration details can be found on the official elastic website. Open powershell as administrator and change directory to C:\Program Files\Winlogbeat, and run commands below : 1 2 3 4 5 PowerShell.exe -ExecutionPolicy UnRestricted -File .\install-service-winlogbeat.ps1 .\winlogbeat.exe test config -c .\winlogbeat.yml -e .\winlogbeat.exe setup -e Start-Service winlogbeat Finally, go to ELK and check, you’ll see all the logs Ingested successfully to Kibana web Interface. Conclusion Today, we managed to succesfully view and consume the Microsoft-Windows-Threat-Intelligence Provider events log, and ship them To ELK stack. In the Next post, I will show you how we can take advantage of this provider to detect some adversary attack like Process Injection, and to understand why Microsoft’s “Threat Intelligence Tracing” is useful and much needed in detection of modern and often obscure injection techniques." /><link rel="canonical" href="https://hackbalak.github.io/posts/ETW-TI-Provider/" /><meta property="og:url" content="https://hackbalak.github.io/posts/ETW-TI-Provider/" /><meta property="og:site_name" content="HackBalak blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-15T18:10:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Getting started with the Microsoft-Windows-Threat-Intelligence ETW Provider" /><meta name="twitter:site" content="@H4ckBalak" /><meta name="twitter:creator" content="@HackBalak" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"HackBalak"},"dateModified":"2022-03-17T17:32:30+01:00","datePublished":"2022-03-15T18:10:00+01:00","description":"TL;DR The Microsoft-Windows-Threat-Intelligence ETW Provider is a very powerful tool to detect many kill chain attacks such as memory injection and others. In this blog, I will show a way to take advantage of this provider, consume its events logs and ship them to ELK stack. Before jumping to the technical steps, let’s talk a little bit about the Threat Intelligence ETW(Event Tracing for Windows) Provider. The Microsoft-Windows-Threat-Intelligence ETW Provider is an excellent tool to detect process injection, and other type of attacks. Unlike usermode hooking or in-process ETW Providers, avoiding or tampering with the Threat-Intelligence is very difficult. However, to subscribe to this Provider requires a process with very special privileges, marked as Protected Process Light (PPL) ‘Anti-Malware’ or higher. To legitimately run a program at this level you must submit a driver to Microsoft to be co-signed by them, something not everyone has the inclination or reputation to do. source : pathtofile Let’s get started … DISCLAMER: In this article, I am not going to cover the deployment of the ELK stack. I may write another blog talking about multiple ways to deploy it in your own lab. But mainly here I am just using this docker-compose which will do all the boring configuration stuff on your behalf. Required Tools Windows 10 VM ELK stack WinlogBeat NSSM SealighterTI Walkthrough Step 1 On a windows 10 VM, download the Assets from the links below : SealighterTI.exe + sealighter_provider.man PS: Disable windows defender before downloading the SealighterTI.exe, because it will consider it malicious. Otherwise, you can clone the repository on your machine and build the exe. For my case, I just downloaded the pre-built binarie, it works fine. Check the SealighterTI Project for more details. Step 2 Create a repository on the C:\\Program Files\\ location, and move the two downloaded files. Then, go to Microsoft windows defender, and add that folder to windows defender exclusion. Select the SealighterTI folder and click Ok. after that you can activate windows defender real-time protection again. Step 3 First Open up the sealigher_provider.man in a text editor, and replace all uses of !!SEALIGHTER_LOCATION!! with the full path to the SealighterTI.exe binary. Then from an elevated command prompt run: 1 wevtutil im path/to/sealigher_provider.man Step 4 Download NSSM ,Extract it and move it to C:\\Program Files\\. What is nssm.exe? The genuine nssm.exe file is a software component of NSSM by Iian Patterson. Non-Sucking Service Manager is a service manager for Microsoft Windows. Nssm.exe launches the Non-Sucking Service Manager program. This is not an essential Windows process and can be disabled if known to create problems. NSSM is a free utility that manages background and foreground services and processes. The program can be set to automatically restart failing services. The program also logs all progress in an Event Log, making it easier to identify applications that aren’t behaving as they should. We will use NSSM to run SealighterTI as a service automatically without the need to start it every time you reboot your machine. open an Administrator command prompt, change directory to the location of the nssm exe, and run the following command. nssm install SealighterTI a window will pop-up as the picture shows above. you just have to fill in the path of the sealighterTI folder and executable and the argument -d . Then click on Install service . And finally the SealighterTI service is installed succesfully. Step 5 Open windows services.msc , Find SealighterTI service and click on Start. and you’re done. Now go to Event Viewer and check The Sealighter/Operational logs. NOTE : After running the SealighterTI service, you’ll discover that the number of event logs on event viewer doesn’t bypass 5** event, and you may think that the TI provider doesn’t log correctly.however that is not correct,But you just need to configure the Log proprieties on the right panel on event viewer, then change The maximum log size to a bigger number ^_^ Step 6 Now it’s Time to ship Microsoft-Windows-Threat-Intelligence ETW provider logs to ELK stack. Download Winlogbeat zip and extract it. Create a Folder on C:\\Program Files\\ and name it winlogbeat and move all the extracted files from the zip folder. Open winlogbeat.yml and add this line under the winlogbeat.event_logs . 1 2 3 winlogbeat.event_logs: - name: Sealighter/Operational More configuration details can be found on the official elastic website. Open powershell as administrator and change directory to C:\\Program Files\\Winlogbeat, and run commands below : 1 2 3 4 5 PowerShell.exe -ExecutionPolicy UnRestricted -File .\\install-service-winlogbeat.ps1 .\\winlogbeat.exe test config -c .\\winlogbeat.yml -e .\\winlogbeat.exe setup -e Start-Service winlogbeat Finally, go to ELK and check, you’ll see all the logs Ingested successfully to Kibana web Interface. Conclusion Today, we managed to succesfully view and consume the Microsoft-Windows-Threat-Intelligence Provider events log, and ship them To ELK stack. In the Next post, I will show you how we can take advantage of this provider to detect some adversary attack like Process Injection, and to understand why Microsoft’s “Threat Intelligence Tracing” is useful and much needed in detection of modern and often obscure injection techniques.","headline":"Getting started with the Microsoft-Windows-Threat-Intelligence ETW Provider","mainEntityOfPage":{"@type":"WebPage","@id":"https://hackbalak.github.io/posts/ETW-TI-Provider/"},"url":"https://hackbalak.github.io/posts/ETW-TI-Provider/"}</script><title>Getting started with the Microsoft-Windows-Threat-Intelligence ETW Provider | HackBalak blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="HackBalak blog"><meta name="application-name" content="HackBalak blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://raw.githubusercontent.com/HackBalak/Hackbalak.github.io/main/assets/img/avatar.gif" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">HackBalak blog</a></div><div class="site-subtitle font-italic">A hacker posts Area</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/HackBalak" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/H4ckBalak" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://discordapp.com/users/711646098002935869" aria-label="discord" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-discord"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['omar.elkdf.19','gmail.com'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/omar-elkaddafi-4742561ba" aria-label="linkedin" class="order-7" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Getting started with the Microsoft-Windows-Threat-Intelligence ETW Provider</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Getting started with the Microsoft-Windows-Threat-Intelligence ETW Provider</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> HackBalak </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Mar 15, 2022, 6:10 PM +0100" >Mar 15<i class="unloaded">2022-03-15T18:10:00+01:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Mar 17, 2022, 5:32 PM +0100" >Mar 17<i class="unloaded">2022-03-17T17:32:30+01:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="837 words">4 min read</span></div></div><div class="post-content"><h3 id="tldr">TL;DR</h3><p>The Microsoft-Windows-Threat-Intelligence ETW Provider is a very powerful tool to detect many kill chain attacks such as memory injection and others.</p><p>In this blog, I will show a way to take advantage of this provider, consume its events logs and ship them to ELK stack.</p><p>Before jumping to the technical steps, let’s talk a little bit about the Threat Intelligence ETW(Event Tracing for Windows) Provider.</p><blockquote><p>The Microsoft-Windows-Threat-Intelligence ETW Provider is an excellent tool to detect process injection, and other type of attacks. Unlike usermode hooking or in-process ETW Providers, avoiding or tampering with the Threat-Intelligence is very difficult.</p><p>However, to subscribe to this Provider requires a process with very special privileges, marked as Protected Process Light (PPL) ‘Anti-Malware’ or higher. To legitimately run a program at this level you must submit a driver to Microsoft to be co-signed by them, something not everyone has the inclination or reputation to do.</p><p>source : <a href="https://github.com/pathtofile/SealighterTI#overview">pathtofile</a></p></blockquote><p>Let’s get started …</p><p><strong>DISCLAMER</strong>:</p><p>In this article, I am not going to cover the deployment of the ELK stack. I may write another blog talking about multiple ways to deploy it in your own lab. But mainly here I am just using this <a href="https://github.com/deviantony/docker-elk">docker-compose</a> which will do all the boring configuration stuff on your behalf.</p><h3 id="required-tools">Required Tools</h3><ul><li>Windows 10 VM<li>ELK stack<li>WinlogBeat<li>NSSM<li>SealighterTI</ul><h2 id="walkthrough">Walkthrough</h2><h4 id="step-1">Step 1</h4><p>On a windows 10 VM, download the Assets from the links below :</p><ul><li><a href="https://github.com/pathtofile/SealighterTI/releases">SealighterTI.exe + sealighter_provider.man</a></ul><p><strong>PS:</strong> Disable windows defender before downloading the SealighterTI.exe, because it will consider it malicious.</p><p>Otherwise, you can clone the repository on your machine and build the exe. For my case, I just downloaded the pre-built binarie, it works fine.</p><p>Check the <a href="https://github.com/pathtofile/SealighterTI">SealighterTI Project</a> for more details.</p><h4 id="step-2">Step 2</h4><p>Create a repository on the C:\Program Files\ location, and move the two downloaded files.</p><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/1.png?raw=true" /></p><p>Then, go to Microsoft windows defender, and add that folder to windows defender exclusion.</p><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/1-1.png?raw=true" /></p><p>Select the SealighterTI folder and click Ok.</p><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/1-1-1.png?raw=true" /></p><p>after that you can activate windows defender real-time protection again.</p><h4 id="step-3">Step 3</h4><p>First Open up the sealigher_provider.man in a text editor, and replace all uses of <code class="language-plaintext highlighter-rouge">!!SEALIGHTER_LOCATION!!</code> with the full path to the SealighterTI.exe binary.</p><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/2.png?raw=true" /></p><p>Then from an elevated command prompt run:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>wevtutil im path/to/sealigher_provider.man
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/3.png?raw=true" /></p><h4 id="step-4">Step 4</h4><p>Download <a href="https://nssm.cc/ci/nssm-2.24-101-g897c7ad.zip">NSSM</a> ,Extract it and move it to <code class="language-plaintext highlighter-rouge">C:\Program Files\</code>.</p><blockquote><p><strong>What is nssm.exe?</strong></p><p>The genuine nssm.exe file is a software component of NSSM by Iian Patterson. <em>Non-Sucking Service Manager</em> is a service manager for Microsoft Windows. <strong>Nssm.exe</strong> launches the Non-Sucking Service Manager program. This is not an essential Windows process and can be disabled if known to create problems. NSSM is a free utility that manages background and foreground services and processes. The program can be set to automatically restart failing services. The program also logs all progress in an Event Log, making it easier to identify applications that aren’t behaving as they should.</p></blockquote><p>We will use NSSM to run SealighterTI as a service automatically without the need to start it every time you reboot your machine.</p><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/4.png?raw=true" /></p><p>open an Administrator command prompt, change directory to the location of the nssm exe, and run the following command.</p><p><code class="language-plaintext highlighter-rouge">nssm install SealighterTI</code></p><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/5.png?raw=true" /></p><p>a window will pop-up as the picture shows above. you just have to fill in the path of the sealighterTI folder and executable and the argument <code class="language-plaintext highlighter-rouge">-d</code> . Then click on <strong>Install service</strong> .</p><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/5-1.png?raw=true" /></p><p>And finally the SealighterTI service is installed succesfully.</p><h4 id="step-5">Step 5</h4><p>Open windows <code class="language-plaintext highlighter-rouge">services.msc</code> , Find SealighterTI service and click on Start.</p><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/6.png?raw=true" /></p><p>and you’re done.</p><p>Now go to Event Viewer and check The Sealighter/Operational logs.</p><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/7.png?raw=true" /></p><p><strong>NOTE :</strong></p><p>After running the SealighterTI service, you’ll discover that the number of event logs on event viewer doesn’t bypass 5** event, and you may think that the TI provider doesn’t log correctly.however that is not correct,But you just need to configure the Log proprieties on the right panel on event viewer, then change <code class="language-plaintext highlighter-rouge">The maximum log size to a bigger number ^_^</code></p><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/7-1.png?raw=true" /></p><h4 id="step-6">Step 6</h4><p>Now it’s Time to ship Microsoft-Windows-Threat-Intelligence ETW provider logs to ELK stack.</p><ul><li>Download <a href="https://www.elastic.co/fr/downloads/beats/winlogbeat">Winlogbeat</a> zip and extract it.<li>Create a Folder on <code class="language-plaintext highlighter-rouge">C:\Program Files\</code> and name it winlogbeat and move all the extracted files from the zip folder.</ul><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/a1.png?raw=true" /></p><ul><li>Open <code class="language-plaintext highlighter-rouge">winlogbeat.yml</code> and add this line under the winlogbeat.event_logs .</ul><div class="language-yaml highlighter-rouge"><div class="code-header"> <span text-data=" YAML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="na">winlogbeat.event_logs</span><span class="pi">:</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Sealighter/Operational</span>
</pre></table></code></div></div><p>More configuration details can be found on the official elastic website.</p><ul><li>Open powershell as administrator and change directory to <code class="language-plaintext highlighter-rouge">C:\Program Files\Winlogbeat</code>, and run commands below :</ul><div class="language-powershell highlighter-rouge"><div class="code-header"> <span text-data=" Powershell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">PowerShell.exe</span><span class="w"> </span><span class="nt">-ExecutionPolicy</span><span class="w"> </span><span class="nx">UnRestricted</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="o">.</span><span class="nx">\install-service-winlogbeat.ps1</span><span class="w">
</span><span class="o">.</span><span class="n">\winlogbeat.exe</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="o">.</span><span class="nx">\winlogbeat.yml</span><span class="w"> </span><span class="nt">-e</span><span class="w">
</span><span class="o">.</span><span class="n">\winlogbeat.exe</span><span class="w"> </span><span class="nx">setup</span><span class="w"> </span><span class="nt">-e</span><span class="w">
</span><span class="n">Start-Service</span><span class="w"> </span><span class="nx">winlogbeat</span><span class="w">

</span></pre></table></code></div></div><p>Finally, go to ELK and check, you’ll see all the logs Ingested successfully to Kibana web Interface.</p><p><img data-proofer-ignore data-src="https://github.com/HackBalak/Hackbalak.github.io/blob/main/_posts/Aseets/ETW-TI/last.png?raw=true" /></p><h2 id="conclusion">Conclusion</h2><p>Today, we managed to succesfully view and consume the Microsoft-Windows-Threat-Intelligence Provider events log, and ship them To ELK stack. In the Next post, I will show you how we can take advantage of this provider to detect some adversary attack like Process Injection, and to understand why Microsoft’s “Threat Intelligence Tracing” is useful and much needed in detection of modern and often obscure injection techniques.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blogging/'>Blogging</a>, <a href='/categories/threat-hunting/'>Threat Hunting</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/threat-hunting/" class="post-tag no-text-decoration" >Threat Hunting</a> <a href="/tags/elk-stack/" class="post-tag no-text-decoration" >ELK stack</a> <a href="/tags/etw/" class="post-tag no-text-decoration" >ETW</a> <a href="/tags/threat-intelligence/" class="post-tag no-text-decoration" >Threat-Intelligence</a> <a href="/tags/blue-teaming/" class="post-tag no-text-decoration" >Blue Teaming</a> <a href="/tags/attack-detection/" class="post-tag no-text-decoration" >Attack Detection</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Getting started with the Microsoft-Windows-Threat-Intelligence ETW Provider - HackBalak blog&url=https://hackbalak.github.io/posts/ETW-TI-Provider/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Getting started with the Microsoft-Windows-Threat-Intelligence ETW Provider - HackBalak blog&u=https://hackbalak.github.io/posts/ETW-TI-Provider/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Getting started with the Microsoft-Windows-Threat-Intelligence ETW Provider - HackBalak blog&url=https://hackbalak.github.io/posts/ETW-TI-Provider/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://hackbalak.github.io/posts/ETW-TI-Provider/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="" title-succeed=""> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/ETW-TI-Provider/">Getting started with the Microsoft-Windows-Threat-Intelligence ETW Provider</a><li><a href="/posts/setting-up-an-Nginx-C2-Redirector/">Setting up an Nginx Redirector for covenant C2</a><li><a href="/posts/REDCELL/">Setting up an automated Red Team Infrastructure (REDCELL)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/red-teaming/">red teaming</a> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/attack-detection/">Attack Detection</a> <a class="post-tag" href="/tags/blue-teaming/">Blue Teaming</a> <a class="post-tag" href="/tags/covenant-c2/">covenant C2</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/elk-stack/">ELK stack</a> <a class="post-tag" href="/tags/etw/">ETW</a> <a class="post-tag" href="/tags/infrastructure-as-code/">infrastructure as code</a> <a class="post-tag" href="/tags/reverse-proxy/">reverse proxy</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/setting-up-an-Nginx-C2-Redirector/"><div class="card-body"> <span class="timeago small" >Sep 8, 2021<i class="unloaded">2021-09-08T14:10:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Setting up an Nginx Redirector for covenant C2</h3><div class="text-muted small"><p> What is covenanat C2 ? Covenant is a .NET command and control framework and web application that aims to highlight the attack surface of .NET, make the use of offensive .NET tradecraft easier, a...</p></div></div></a></div><div class="card"> <a href="/posts/REDCELL/"><div class="card-body"> <span class="timeago small" >Sep 16, 2021<i class="unloaded">2021-09-16T18:10:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Setting up an automated Red Team Infrastructure (REDCELL)</h3><div class="text-muted small"><p> Redcell is an Infrastructure as Code Lab of red teamers operations , it’s built using Vagrant and Ansible , and it can be deployed and run locally . This lab is made of six virtual machines that se...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/REDCELL/" class="btn btn-outline-primary" prompt="Older"><p>Setting up an automated Red Team Infrastructure (REDCELL)</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://hackbalak.github.io/posts/ETW-TI-Provider/'; this.page.identifier = '/posts/ETW-TI-Provider/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://hackbalak.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (modeToggle !== null) { modeToggle.addEventListener('click', reloadDisqus); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">HackBalak</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/red-teaming/">red teaming</a> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/attack-detection/">Attack Detection</a> <a class="post-tag" href="/tags/blue-teaming/">Blue Teaming</a> <a class="post-tag" href="/tags/covenant-c2/">covenant C2</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/elk-stack/">ELK stack</a> <a class="post-tag" href="/tags/etw/">ETW</a> <a class="post-tag" href="/tags/infrastructure-as-code/">infrastructure as code</a> <a class="post-tag" href="/tags/reverse-proxy/">reverse proxy</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
